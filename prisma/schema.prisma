generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────────────
// USER
// ─────────────────────────────────────────────

enum UserRole {
  LEARNER
  TRAINER
  ADMIN
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      UserRole @default(LEARNER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollments      Enrollment[]
  groupMembers     GroupMember[]
  testSubmissions  TestSubmission[]
  discussionTopics DiscussionTopic[]
  discussionReplies DiscussionReply[]
  presences        Presence[]
  assignments      AssignmentSubmission[]
}

// ─────────────────────────────────────────────
// CLASS
// ─────────────────────────────────────────────

model Class {
  id            String   @id @default(uuid())
  title         String
  description   String
  imageUrl      String?
  durationHours Int
  scheduleStart DateTime
  scheduleEnd   DateTime
  method        String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  courses         Course[]
  enrollments     Enrollment[]
  placementTests  PlacementTest[]
  classTimelines  ClassTimeline[]
  learningPoints  ClassLearningPoint[]
  groups          Group[]
  discussions     DiscussionTopic[]
}

model ClassLearningPoint {
  id      String @id @default(uuid())
  classId String
  text    String
  order   Int

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
}

model ClassTimeline {
  id      String   @id @default(uuid())
  classId String
  title   String
  date    DateTime
  order   Int

  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)
}

// ─────────────────────────────────────────────
// ENROLLMENT
// ─────────────────────────────────────────────

enum EnrollmentStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum LearningObjective {
  CAREER_SWITCH
  JOB_SEEKER
  ACADEMIC_PURPOSE
  CERTIFICATION
  UPSKILLING
}

model Enrollment {
  id                String            @id @default(uuid())
  userId            String
  classId           String
  status            EnrollmentStatus  @default(PENDING)
  profession        String?
  yearsOfExperience Int?
  workField         String?
  educationField    String?
  jobIndustry       String?
  finalExpectations String?
  cvFileUrl         String?
  enrolledAt        DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  user                 User                       @relation(fields: [userId], references: [id])
  class                Class                      @relation(fields: [classId], references: [id])
  learningObjectives   EnrollmentLearningObjective[]

  @@unique([userId, classId])
}

model EnrollmentLearningObjective {
  id           String            @id @default(uuid())
  enrollmentId String
  objective    LearningObjective

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
}

// ─────────────────────────────────────────────
// GROUP
// ─────────────────────────────────────────────

model Group {
  id         String   @id @default(uuid())
  classId    String
  name       String
  createdAt  DateTime @default(now())

  class   Class         @relation(fields: [classId], references: [id])
  members GroupMember[]
}

model GroupMember {
  id      String @id @default(uuid())
  groupId String
  userId  String

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([groupId, userId])
}

// ─────────────────────────────────────────────
// COURSE
// ─────────────────────────────────────────────

model Course {
  id          String   @id @default(uuid())
  classId     String
  title       String
  description String
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  class            Class             @relation(fields: [classId], references: [id])
  sessions         Session[]
  learningObjectives CourseLearningObjective[]
  entrySkills      CourseEntrySkill[]
  tools            CourseTool[]
  assignments      Assignment[]
}

model CourseLearningObjective {
  id        String @id @default(uuid())
  courseId  String
  code      String
  text      String
  order     Int

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model CourseEntrySkill {
  id       String @id @default(uuid())
  courseId String
  text     String
  order    Int

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model CourseTool {
  id       String @id @default(uuid())
  courseId String
  name     String

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

// ─────────────────────────────────────────────
// SESSION
// ─────────────────────────────────────────────

enum SessionType {
  ASYNCHRONOUS
  SYNCHRONOUS
  ASSIGNMENT
}

model Session {
  id          String      @id @default(uuid())
  courseId    String
  title       String
  type        SessionType
  scheduledAt DateTime?
  order       Int
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  course             Course              @relation(fields: [courseId], references: [id])
  referenceMaterials ReferenceMaterial[]
  video              SessionVideo?
  zoomSession        ZoomSession?
  preSessions        PreTest[]
  postSessions       PostTest[]
  exercises          Exercise[]
  presences          Presence[]
}

model SessionVideo {
  id        String @id @default(uuid())
  sessionId String @unique
  title     String
  url       String

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model ZoomSession {
  id          String  @id @default(uuid())
  sessionId   String  @unique
  link        String
  status      String
  recordingUrl String?
  recordingTitle String?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

model ReferenceMaterial {
  id          String @id @default(uuid())
  sessionId   String
  name        String
  description String?
  fileUrl     String?

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// ─────────────────────────────────────────────
// PLACEMENT TEST
// ─────────────────────────────────────────────

model PlacementTest {
  id              String   @id @default(uuid())
  classId         String   @unique
  title           String
  description     String?
  introDescription String?
  durationMinutes Int
  deadline        DateTime?
  instructions    String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  class               Class                @relation(fields: [classId], references: [id])
  objectiveQuestions  PlacementObjectiveQuestion[]
  essayQuestions      PlacementEssayQuestion[]
  projectQuestions    PlacementProjectQuestion[]
  submissions         TestSubmission[]
}

model PlacementObjectiveQuestion {
  id              String @id @default(uuid())
  placementTestId String
  question        String
  options         String[]
  points          Int
  order           Int

  placementTest PlacementTest @relation(fields: [placementTestId], references: [id], onDelete: Cascade)
  answers       ObjectiveAnswer[]
}

model PlacementEssayQuestion {
  id              String @id @default(uuid())
  placementTestId String
  question        String
  points          Int
  order           Int

  placementTest PlacementTest @relation(fields: [placementTestId], references: [id], onDelete: Cascade)
  answers       EssayAnswer[]
}

model PlacementProjectQuestion {
  id              String   @id @default(uuid())
  placementTestId String
  question        String
  requirements    String[]
  points          Int
  order           Int

  placementTest PlacementTest @relation(fields: [placementTestId], references: [id], onDelete: Cascade)
  answers       ProjectAnswer[]
}

model TestSubmission {
  id              String   @id @default(uuid())
  userId          String
  placementTestId String
  isFinished      Boolean  @default(false)
  submittedAt     DateTime?
  createdAt       DateTime @default(now())

  user          User          @relation(fields: [userId], references: [id])
  placementTest PlacementTest @relation(fields: [placementTestId], references: [id])
  objectiveAnswers ObjectiveAnswer[]
  essayAnswers     EssayAnswer[]
  projectAnswers   ProjectAnswer[]

  @@unique([userId, placementTestId])
}

model ObjectiveAnswer {
  id               String @id @default(uuid())
  submissionId     String
  questionId       String
  selectedOption   String?

  submission TestSubmission             @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question   PlacementObjectiveQuestion @relation(fields: [questionId], references: [id])
}

model EssayAnswer {
  id           String @id @default(uuid())
  submissionId String
  questionId   String
  answerText   String?

  submission TestSubmission         @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question   PlacementEssayQuestion @relation(fields: [questionId], references: [id])
}

model ProjectAnswer {
  id           String @id @default(uuid())
  submissionId String
  questionId   String
  fileUrl      String?
  answerText   String?

  submission TestSubmission           @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question   PlacementProjectQuestion @relation(fields: [questionId], references: [id])
}

// ─────────────────────────────────────────────
// PRE-TEST & POST-TEST
// ─────────────────────────────────────────────

model PreTest {
  id              String   @id @default(uuid())
  sessionId       String
  title           String
  durationMinutes Int?
  createdAt       DateTime @default(now())

  session   Session           @relation(fields: [sessionId], references: [id])
  questions PreTestQuestion[]
}

model PreTestQuestion {
  id         String   @id @default(uuid())
  preTestId  String
  question   String
  options    String[]
  points     Int
  order      Int

  preTest PreTest @relation(fields: [preTestId], references: [id], onDelete: Cascade)
}

model PostTest {
  id              String   @id @default(uuid())
  sessionId       String
  title           String
  durationMinutes Int?
  createdAt       DateTime @default(now())

  session   Session            @relation(fields: [sessionId], references: [id])
  questions PostTestQuestion[]
}

model PostTestQuestion {
  id          String   @id @default(uuid())
  postTestId  String
  question    String
  options     String[]
  points      Int
  order       Int

  postTest PostTest @relation(fields: [postTestId], references: [id], onDelete: Cascade)
}

// ─────────────────────────────────────────────
// EXERCISE
// ─────────────────────────────────────────────

model Exercise {
  id        String   @id @default(uuid())
  sessionId String
  title     String
  detail    String?
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id])
}

// ─────────────────────────────────────────────
// ASSIGNMENT
// ─────────────────────────────────────────────

enum AssignmentTag {
  INDIVIDUAL
  GROUP
}

enum AssignmentType {
  PLACEMENT
  PRE_TEST
  POST_TEST
  ASSIGNMENT
  EXERCISE
  FINAL_PROJECT
}

model Assignment {
  id          String         @id @default(uuid())
  courseId    String
  sessionId   String?
  title       String
  detail      String?
  tag         AssignmentTag
  type        AssignmentType
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  course      Course                 @relation(fields: [courseId], references: [id])
  submissions AssignmentSubmission[]
}

model AssignmentSubmission {
  id           String    @id @default(uuid())
  assignmentId String
  userId       String
  fileUrl      String?
  note         String?
  submittedAt  DateTime?
  createdAt    DateTime  @default(now())

  assignment Assignment @relation(fields: [assignmentId], references: [id])
  user       User       @relation(fields: [userId], references: [id])

  @@unique([assignmentId, userId])
}

// ─────────────────────────────────────────────
// PRESENCE (ATTENDANCE)
// ─────────────────────────────────────────────

model Presence {
  id        String   @id @default(uuid())
  sessionId String
  userId    String
  present   Boolean  @default(false)
  createdAt DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([sessionId, userId])
}

// ─────────────────────────────────────────────
// DISCUSSION
// ─────────────────────────────────────────────

enum DiscussionTopicType {
  LEARNING_RESOURCE
  TECHNICAL_HELP
  GENERAL
}

model DiscussionTopic {
  id        String              @id @default(uuid())
  classId   String
  authorId  String
  title     String
  preview   String?
  content   String
  type      DiscussionTopicType
  likeCount Int                 @default(0)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  class   Class             @relation(fields: [classId], references: [id])
  author  User              @relation(fields: [authorId], references: [id])
  replies DiscussionReply[]
}

model DiscussionReply {
  id        String   @id @default(uuid())
  topicId   String
  authorId  String
  content   String
  likeCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  topic  DiscussionTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  author User            @relation(fields: [authorId], references: [id])
}
